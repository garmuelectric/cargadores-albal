<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Cargadores Albal - Contador en horas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase COMPAT -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { margin:0; font-family:sans-serif; }
#map { height:100vh; }

.popup-container { text-align:center; width:180px; }
.popup-title { font-weight:bold; font-size:16px; margin-bottom:5px; display:block; }
.popup-estado { font-weight:bold; font-size:14px; margin-bottom:5px; display:block; }
.popup-timer { font-size:13px; color:#333; margin-bottom:5px; }

.popup-btn { padding:8px 12px; border:none; border-radius:6px; margin:4px 0; font-weight:bold; cursor:pointer; width:100%; font-size:14px; }

#alerta-banner {
  position: fixed; top: -50px; left: 50%;
  transform: translateX(-50%);
  background: #f39c12; color: #fff; font-weight:bold;
  padding: 10px 20px; border-radius:6px;
  z-index: 1000; box-shadow:0 2px 6px rgba(0,0,0,0.3);
  transition: top 0.5s ease-in-out;
}
#alerta-banner.show { top: 10px; }
</style>
</head>
<body>
<div id="map"></div>
<div id="alerta-banner"></div>

<script>
// -------------------- Mapa --------------------
const map = L.map('map').setView([39.396, -0.409], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap'
}).addTo(map);

// -------------------- Firebase --------------------
let db = null;
try {
  const firebaseConfig = {
    apiKey: "AIzaSyBCk-EzZLoMp5QVm-mxheP_tb_7ycoDkfs",
    authDomain: "cargadores-de-albal.firebaseapp.com",
    databaseURL: "https://cargadores-de-albal-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "cargadores-de-albal",
    storageBucket: "cargadores-de-albal.firebasestorage.app",
    messagingSenderId: "827036195864",
    appId: "1:827036195864:web:6f737a763b94a51234376d"
  };
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  console.log("Firebase conectado ✅");
} catch(e){ console.warn("Firebase NO conectado:", e); }

// -------------------- Config --------------------
const cargadores = [
  { id:'San Carlos-A', lat:39.39896, lng:-0.40768, offset:[0,0] },
  { id:'San Carlos-B', lat:39.39880, lng:-0.40773, offset:[0,0] },
  { id:'Reten Policia-A', lat:39.39471, lng:-0.41141, offset:[0,0] },
  { id:'Reten Policia-B', lat:39.39454, lng:-0.41145, offset:[0,0] },
  { id:'C.E.I.P. Balaguera-A', lat:39.39319, lng:-0.40987, offset:[0,0] },
  { id:'C.E.I.P. Balaguera-B', lat:39.39319, lng:-0.40987, offset:[0.00015,0.00015] } // desplazamiento visible
];

let marcadores = {};
let estados = {};
let timersPopup = {};
const TIEMPO_USO_MS = 4*60*60*1000; // 4 horas
const TIEMPO_AMBAR_MS = 5*60*1000;   // 5 min
const ALERTA_MS = 10*60*1000;        // 10 min

// -------------------- Banner --------------------
function mostrarAlerta(texto){
  const banner = document.getElementById("alerta-banner");
  banner.innerText = texto;
  banner.classList.add("show");
  setTimeout(()=> banner.classList.remove("show"),7000);
}

// -------------------- Popup --------------------
function crearPopup(id){
  const div=document.createElement("div");
  div.className="popup-container";

  const titulo=document.createElement("span");
  titulo.className="popup-title";
  titulo.innerText=id;
  div.appendChild(titulo);

  const estado=document.createElement("span");
  estado.className="popup-estado";
  estado.innerText="Estado: "+(estados[id]||"green").toUpperCase();
  div.appendChild(estado);

  const timerSpan=document.createElement("span");
  timerSpan.className="popup-timer";
  timerSpan.innerText="Calculando...";
  div.appendChild(timerSpan);

  const btnLibre=document.createElement("button");
  btnLibre.innerText="Libre";
  btnLibre.className="popup-btn";
  btnLibre.style.background="green";
  btnLibre.style.color="white";
  btnLibre.onclick=()=>cambiarEstado(id,"green");
  div.appendChild(btnLibre);

  const btnUso=document.createElement("button");
  btnUso.innerText="En uso";
  btnUso.className="popup-btn";
  btnUso.style.background="red";
  btnUso.style.color="white";
  btnUso.onclick=()=>cambiarEstado(id,"red");
  div.appendChild(btnUso);

  function actualizarTimer(){
    const val = estados[id+"_ts"]||0;
    if(estados[id]==="red" && val){
      const elapsed = Date.now() - val;
      let restante = TIEMPO_USO_MS + TIEMPO_AMBAR_MS - elapsed;
      if(restante<0) restante=0;

      const horas = Math.floor(restante / 3600000);
      const minutos = Math.floor((restante % 3600000)/60000);
      const segundos = Math.floor((restante % 60000)/1000);

      timerSpan.innerText=`Cambio a verde en: ${horas}h ${minutos}m ${segundos}s`;
    } else if(estados[id]==="orange"){
      timerSpan.innerText="En ámbar, pronto verde";
    } else timerSpan.innerText="Libre";
  }

  actualizarTimer();
  if(timersPopup[id]) clearInterval(timersPopup[id]);
  timersPopup[id]=setInterval(actualizarTimer,1000);

  return div;
}

// -------------------- Cambiar estado --------------------
function cambiarEstado(id,nuevoEstado){
  if(!db) return;
  const timestamp = Date.now();
  db.ref("cargadores/"+id).set({estado:nuevoEstado,timestamp});
  estados[id+"_ts"]=timestamp;
  if(nuevoEstado==="red") programarTimers(id,timestamp);
}

// -------------------- Timers --------------------
function programarTimers(id,startTime){
  if(!window.timers) window.timers={};
  if(window.timers[id]){
    clearTimeout(window.timers[id].amber);
    clearTimeout(window.timers[id].verde);
    clearTimeout(window.timers[id].alerta);
  } else window.timers[id]={};

  const ahora=Date.now();
  const elapsed=ahora-startTime;
  const restante4h=TIEMPO_USO_MS-elapsed;
  const restanteAlerta=TIEMPO_USO_MS-ALERTA_MS-elapsed;
  const restanteAmber=TIEMPO_USO_MS+TIEMPO_AMBAR_MS-elapsed;

  if(restanteAlerta>0){
    window.timers[id].alerta=setTimeout(()=> mostrarAlerta(`Cargador ${id} debe retirarse en 10 min`),restanteAlerta);
  } else if(restanteAlerta<=0 && restante4h>0){
    mostrarAlerta(`Cargador ${id} debe retirarse en 10 min`);
  }

  if(restante4h>0){
    window.timers[id].amber=setTimeout(()=> db.ref("cargadores/"+id+"/estado").set("orange"),restante4h);
  } else db.ref("cargadores/"+id+"/estado").set("orange");

  if(restanteAmber>0){
    window.timers[id].verde=setTimeout(()=> db.ref("cargadores/"+id+"/estado").set("green"),restanteAmber);
  } else db.ref("cargadores/"+id+"/estado").set("green");
}

// -------------------- Crear marcadores --------------------
cargadores.forEach(c=>{
  const lat=c.lat+(c.offset?.[0]||0);
  const lng=c.lng+(c.offset?.[1]||0);
  const marker=L.circleMarker([lat,lng],{
    radius:12, color:"#000", fillOpacity:0.9, fillColor:"green"
  }).addTo(map);
  marcadores[c.id]=marker;

  if(db){
    const ref=db.ref("cargadores/"+c.id);
    ref.once("value",snap=>{
      if(snap.val()===null) ref.set({estado:"green",timestamp:Date.now()});
    });
    ref.on("value",snap=>{
      const val=snap.val();
      const estado=val?.estado||"green";
      estados[c.id]=estado;
      estados[c.id+"_ts"]=val?.timestamp||Date.now();
      marker.setStyle({fillColor:estado});
      if(marker.isPopupOpen()) marker.setPopupContent(crearPopup(c.id));
      if(estado==="red" && val?.timestamp) programarTimers(c.id,val.timestamp);
    });
  }

  marker.on("click",()=> marker.bindPopup(crearPopup(c.id)).openPopup());
});
</script>
</body>
</html>


