<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>GarmuElectric</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { 
  margin:0; 
  font-family:Arial, sans-serif; 
}

#map { 
  height:100vh; 
}

/* HEADER */
.header {
  position:absolute;
  top:15px;
  left:50%;
  transform:translateX(-50%);
  background:#111;
  color:white;
  padding:12px 25px;
  border-radius:15px;
  font-size:18px;
  font-weight:bold;
  z-index:1000;
  text-align:center;
}

/* RESPONSIVE MÃ“VIL */
@media (max-width: 600px) {
  .header {
    top:10px;
    font-size:16px;
    padding:8px 16px;
  }
}

/* ICONO */
.icono-rayo {
  position: relative;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
  transition: transform 0.3s ease;
}

.icono-rayo.en-uso {
  animation: pulso 1s infinite;
}

@keyframes pulso {
  0% { transform: scale(1); }
  50% { transform: scale(1.15); }
  100% { transform: scale(1); }
}
</style>
</head>
<body>

<div class="header">âš¡ GarmuElectric Reparaciones e Instalaciones Electricas  606774561 </div>
<div id="map"></div>

<script>

// ================= FIREBASE CONFIG =================
const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "cargadores-de-albal.firebaseapp.com",
  databaseURL: "https://cargadores-de-albal-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cargadores-de-albal",
  storageBucket: "cargadores-de-albal.appspot.com",
  messagingSenderId: "XXXX",
  appId: "XXXX"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================= MAPA =================
const map = L.map('map').setView([39.396, -0.409], 17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// ================= CONFIG =================
const TIEMPO_USO = 4 * 60 * 60 * 1000;
const HORA_NOCTURNA_INICIO = 22;
const HORA_NOCTURNA_FIN = 7;

function esHorarioNocturno(){
  const hora = new Date().getHours();
  return (hora >= HORA_NOCTURNA_INICIO || hora < HORA_NOCTURNA_FIN);
}

const cargadores = [
  { id:'San Carlos-A', lat:39.39896, lng:-0.40768 },
  { id:'San Carlos-B', lat:39.39880, lng:-0.40773 },
  { id:'Reten Policia-A', lat:39.39471, lng:-0.41141 },
  { id:'Reten Policia-B', lat:39.39454, lng:-0.41145 },
  { id:'CEIP-Balaguera-A', lat:39.39302, lng:-0.40987 },
  { id:'CEIP-Balaguera-B', lat:39.39288, lng:-0.40980 }
];

// ================= ICONO PEQUEÃ‘O =================
function crearIconoRayo(color){
  const svg = `
    <div style="
      width:36px; 
      height:36px; 
      background:${color}; 
      border-radius:50%; 
      display:flex; 
      justify-content:center; 
      align-items:center; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    " class="icono-rayo">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="white">
        <path d="M13 2L3 14H11L9 22L21 8H13L13 2Z"/>
      </svg>
    </div>
  `;
  return L.divIcon({
    html: svg,
    className: "",
    iconSize: [36,36],
    iconAnchor: [18,18],
    popupAnchor: [0,-22]
  });
}

// ================= CONTADOR =================
let timers = {};

function iniciarContador(id, timestamp){
  if(timers[id]) clearInterval(timers[id]);

  timers[id] = setInterval(()=>{
    const t = document.getElementById("timer-"+id);
    if(!t) return;

    if(esHorarioNocturno()){
      t.innerText = "ðŸŒ™ Sin lÃ­mite nocturno";
      return;
    }

    const restante = TIEMPO_USO - (Date.now() - timestamp);

    if(restante <= 0){
      t.innerText = "â›” Tiempo superado";
      return;
    }

    const h = Math.floor(restante/3600000);
    const m = Math.floor((restante%3600000)/60000);
    const s = Math.floor((restante%60000)/1000);

    t.innerText =
      `Restante: ${String(h).padStart(2,"0")}:`+
      `${String(m).padStart(2,"0")}:`+
      `${String(s).padStart(2,"0")}`;

  },1000);
}

// ================= POPUP =================
function crearPopup(id, estado, timestamp){
  const div = document.createElement("div");

  div.innerHTML = `
    <div style="font-size:24px;">âš¡</div>
    <strong>${id}</strong><br>
    ${estado === "red" ? "ðŸ”´ EN USO" : "ðŸŸ¢ LIBRE"}<br>
    <span id="timer-${id}"></span><br>
    <button onclick="cambiarEstado('${id}','green')">ðŸŸ¢ Libre</button>
    <button onclick="cambiarEstado('${id}','red')">ðŸ”´ En uso</button>
  `;

  setTimeout(()=>{
    if(estado === "red" && timestamp){
      iniciarContador(id, timestamp);
    }
  },50);

  return div;
}

// ================= CAMBIAR ESTADO =================
window.cambiarEstado = function(id, estado){
  db.ref("cargadores/"+id).set({
    estado: estado,
    timestamp: Date.now()
  });
};

// ================= MARCADORES =================
cargadores.forEach(c=>{
  let marker = L.marker([c.lat, c.lng], {
    icon: crearIconoRayo("green")
  }).addTo(map);

  const ref = db.ref("cargadores/"+c.id);

  ref.on("value", snap=>{
    const data = snap.val();
    const estado = data?.estado || "green";
    const timestamp = data?.timestamp;

    const color = estado === "red" ? "red" : "green";
    marker.setIcon(crearIconoRayo(color));

    setTimeout(()=>{
      const el = marker.getElement();
      if(!el) return;

      if(estado === "red"){
        el.querySelector(".icono-rayo").classList.add("en-uso");
      } else {
        el.querySelector(".icono-rayo").classList.remove("en-uso");
      }
    },50);

    marker.unbindPopup();
    marker.bindPopup(crearPopup(c.id, estado, timestamp));
  });
});

</script>
</body>
</html>

