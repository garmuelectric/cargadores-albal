<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>GarmuElectric</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { margin:0; font-family:Arial, sans-serif; }
#map { height:100vh; }

.header {
  position:absolute;
  top:15px;
  left:50%;
  transform:translateX(-50%);
  background:#111;
  color:white;
  padding:12px 25px;
  border-radius:15px;
  font-size:18px;
  font-weight:bold;
  z-index:1000;
}

.auth-box {
  position:absolute;
  top:15px;
  right:15px;
  z-index:1000;
}

.auth-box input {
  padding:6px;
  margin:2px;
  border-radius:6px;
  border:1px solid #ccc;
}

.auth-box button {
  padding:6px 10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

.icono-rayo {
  position: relative;
  filter: drop-shadow(0 1px 3px rgba(0,0,0,0.4));
  transition: transform 0.3s ease;
}

.icono-rayo.en-uso {
  animation: pulso 1s infinite;
}

.contador-mini {
  position:absolute;
  bottom:2px;
  left:50%;
  transform:translateX(-50%);
  color:white;
  font-size:10px;
  font-weight:bold;
  text-align:center;
}

@keyframes pulso {
  0% { transform: scale(1); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}
</style>
</head>
<body>

<div class="header">âš¡ GarmuElectric - Reparaciones e Instalaciones ElÃ©ctricas NÂº 606774561</div>

<div class="auth-box" id="authBox">
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="ContraseÃ±a">
  <button onclick="login()">Entrar</button>
  <div id="login-error" style="color:red;margin-top:4px;font-size:12px;"></div>
</div>

<div id="map"></div>

<script>
// ================= FIREBASE CONFIG =================
const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "cargadores-albal-de7f3.firebaseapp.com",
  databaseURL: "https://cargadores-albal-de7f3-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cargadores-albal-de7f3",
  storageBucket: "cargadores-albal-de7f3.appspot.com",
  messagingSenderId: "341134061477",
  appId: "1:341134061477:web:329c5cc52b29ac963a824c"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// ================= USUARIOS =================
const usuarios = {
  "juan@example.com": {id:1, nombre:"Juan PÃ©rez", telefono:"+34600111222"},
  "maria@example.com": {id:2, nombre:"MarÃ­a LÃ³pez", telefono:"+34600333444"},
  "carlos@example.com": {id:3, nombre:"Carlos GÃ³mez", telefono:"+34600555666"}
};

let usuarioActual = null;
let usuarioID = null;
let usuarioTelefono = null;

// ================= AUTH =================
auth.onAuthStateChanged(user=>{
  usuarioActual = user;
  const box = document.getElementById("authBox");
  if(user){
    const info = usuarios[user.email];
    if(!info){
      alert("Usuario no registrado en WhatsApp");
      auth.signOut();
      return;
    }
    usuarioID = info.id;
    usuarioTelefono = info.telefono;
    box.innerHTML = `<span style="background:#28a745;color:white;padding:6px 10px;border-radius:6px;">Conectado</span>
                     <button onclick="logout()">Salir</button>`;
  }
});

function login(){
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const errorDiv = document.getElementById("login-error");
  errorDiv.innerText = "";
  auth.signInWithEmailAndPassword(email,password)
      .catch(error => { errorDiv.innerText = error.message; });
}

function logout(){
  auth.signOut();
  location.reload();
}

// ================= MAPA =================
const map = L.map('map').setView([39.396, -0.409], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// ================= CONFIG =================
const TIEMPO_USO = 4*60*60*1000; // 4h
const cargadores = [
  { id:'San Carlos-A', lat:39.39896, lng:-0.40768 },
  { id:'San Carlos-B', lat:39.39880, lng:-0.40773 },
  { id:'Reten Policia-A', lat:39.39471, lng:-0.41141 },
  { id:'Reten Policia-B', lat:39.39454, lng:-0.41145 },
  { id:'CEIP-Balaguera-A', lat:39.39302, lng:-0.40987 },
  { id:'CEIP-Balaguera-B', lat:39.39288, lng:-0.40980 }
];

// ================= ICONO RAYO PRO =================
function crearIconoRayo(color, texto=""){
  const size = 35;
  const svgSize = 20;
  const contadorSize = 10;
  const svg = `
    <div style="
      width:${size}px; height:${size}px;
      background:${color};
      border-radius:50%;
      display:flex;
      justify-content:center;
      align-items:center;
      position:relative;
      box-shadow:0 1px 3px rgba(0,0,0,0.3);
    " class="icono-rayo">
      <svg width="${svgSize}" height="${svgSize}" viewBox="0 0 24 24" fill="white">
        <path d="M13 2L3 14H11L9 22L21 8H13L13 2Z"/>
      </svg>
      <div class="contador-mini" style="font-size:${contadorSize}px;">${texto}</div>
    </div>
  `;
  return L.divIcon({
    html: svg,
    className: "",
    iconSize:[size,size],
    iconAnchor:[size/2,size/2],
    popupAnchor:[0,-size/2]
  });
}

// ================= CONTADOR =================
function calcularTiempoRestante(timestamp){
  const restante = TIEMPO_USO - (Date.now()-timestamp);
  if(restante<=0) return "â›”";
  const h = Math.floor(restante/3600000);
  const m = Math.floor((restante%3600000)/60000);
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
}

// ================= POPUP =================
function crearPopup(id, estado, telefono){
  const div = document.createElement("div");
  const enlaceWhats = telefono?`<br><a href="https://wa.me/${telefono.replace(/\D/g,'')}" target="_blank">ðŸ“² WhatsApp</a>`:"";
  const botones = `
    <button onclick="cambiarEstado('${id}','green')">ðŸŸ¢ Libre</button>
    <button onclick="cambiarEstado('${id}','red')">ðŸ”´ En uso</button>
  `;
  div.innerHTML = `<div style="font-size:28px;">âš¡</div>
                   <strong>${id}</strong><br>
                   ${estado==="red"?"ðŸ”´ EN USO":"ðŸŸ¢ LIBRE"}<br>
                   ${botones} ${enlaceWhats}`;
  return div;
}

// ================= CAMBIAR ESTADO =================
window.cambiarEstado = function(id, estado){
  if(!usuarioActual){ alert("Inicia sesiÃ³n"); return; }
  db.ref("cargadores/"+id).set({
    estado: estado,
    timestamp: Date.now(),
    usuarioID: usuarioID,
    telefono: usuarioTelefono
  });
};

// ================= MARCADORES =================
cargadores.forEach(c=>{
  const marker = L.marker([c.lat,c.lng],{icon:crearIconoRayo("green")}).addTo(map);
  const ref = db.ref("cargadores/"+c.id);

  ref.on("value", snap=>{
    const data = snap.val()||{};
    const estado = data.estado||"green";
    const timestamp = data.timestamp||Date.now();
    const telefono = data.telefono||null;

    marker.setIcon(crearIconoRayo(estado==="red"?"red":"green", estado==="red"?calcularTiempoRestante(timestamp):""));

    const el = marker.getElement();
    if(el){
      if(estado==="red") el.querySelector(".icono-rayo").classList.add("en-uso");
      else el.querySelector(".icono-rayo").classList.remove("en-uso");
    }

    marker.unbindPopup();
    marker.bindPopup(crearPopup(c.id, estado, telefono));
  });

  setInterval(()=>{
    const el = marker.getElement();
    if(!el) return;
    db.ref("cargadores/"+c.id).once("value").then(snap=>{
      const d = snap.val();
      if(!d) return;
      if(d.estado==="red"){
        el.querySelector(".contador-mini").innerText = calcularTiempoRestante(d.timestamp);
      } else {
        el.querySelector(".contador-mini").innerText = "";
      }
    });
  },1000);
});
</script>
</body>
</html>
